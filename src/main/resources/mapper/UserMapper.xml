<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.parkingmanagement.dao.UserDao">
	<resultMap id="BaseResultMap" type="com.parkingmanagement.entity.system.User" >
		<id column="user_id" property="userId" jdbcType="BIGINT" />
		<result column="username" property="username" jdbcType="VARCHAR" />
		<result column="password" property="password" jdbcType="VARCHAR" />
		<collection property="roles" ofType="com.parkingmanagement.entity.system.Role">
			<!-- 定义这个集合中元素的封装规则 -->
			<id column="role_id" property="roleId" />
			<result column="role_name" property="roleName" jdbcType="VARCHAR"/>
			<result column="role_code" property="roleCode" jdbcType="VARCHAR"/>
			<collection property="permissions" ofType="com.parkingmanagement.entity.system.Permissions">
			<id column="permissions_id" property="permissionsId"/>
			<result column="permissions_name" property="permissionsName" jdbcType="VARCHAR"/>
			<result column="permissions_code" property="permissionsCode" jdbcType="VARCHAR"/>
			</collection>
		</collection>
	</resultMap>

	<sql id="base_select">
		u.user_id,u.username,u.password,r.role_id,r.role_name,r.role_code,p.permissions_id,p.permissions_code,p.permissions_name
	</sql>

	<select id="getUser" resultMap="BaseResultMap" parameterType="Map">
		select 	<include refid="base_select"/>
		FROM USER u
		LEFT JOIN user_role ur ON u.`user_id` = ur.`user_id`
		LEFT JOIN role r ON r.`role_id` = ur.`role_id`
		LEFT JOIN role_permissions rp ON r.`role_id` = rp.`role_id`
		LEFT JOIN permissions p ON p.`permissions_id` = rp.`permissions_id`
		where username = #{username} and password = #{password}
	</select>

	<select id="getUserByUsername" resultMap="BaseResultMap" parameterType="Map">
		select 	<include refid="base_select"/>
		FROM USER u
		LEFT JOIN user_role ur ON u.`user_id` = ur.`user_id`
		LEFT JOIN role r ON r.`role_id` = ur.`role_id`
		LEFT JOIN role_permissions rp ON r.`role_id` = rp.`role_id`
		LEFT JOIN permissions p ON p.`permissions_id` = rp.`permissions_id`
		where username = #{username}
	</select>

	<select id="getList" resultMap="BaseResultMap">
	  select 	<include refid="base_select"/>
	  FROM USER u
	  LEFT JOIN user_role ur ON u.`user_id` = ur.`user_id`
	  LEFT JOIN role r ON r.`role_id` = ur.`role_id`
	  LEFT JOIN role_permissions rp ON r.`role_id` = rp.`role_id`
	  LEFT JOIN permissions p ON p.`permissions_id` = rp.`permissions_id`
	</select>

	<insert id="save" parameterType="com.parkingmanagement.entity.system.User">
		insert into user(username,password) values (#{username},#{password})
	</insert>



</mapper>
 

